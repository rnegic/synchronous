name: Deploy to Server

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

env:
  GO_VERSION: '1.24.4'
  NODE_VERSION: '20'

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate secrets
        run: |
          if [ -z "${{ secrets.SERVER_HOST }}" ]; then
            echo "❌ Error: SERVER_HOST secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.SERVER_USER }}" ]; then
            echo "❌ Error: SERVER_USER secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.SERVER_SSH_KEY }}" ]; then
            echo "❌ Error: SERVER_SSH_KEY secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.DB_DSN }}" ]; then
            echo "❌ Error: DB_DSN secret is not set"
            exit 1
          fi
          
          # Проверка на наличие passphrase (опционально, но рекомендуется если ключ защищен)
          if [ -z "${{ secrets.SERVER_SSH_PASSPHRASE }}" ]; then
            echo "⚠️  Warning: SERVER_SSH_PASSPHRASE is not set"
            echo "   If your SSH key is password-protected, add SERVER_SSH_PASSPHRASE secret"
            echo "   Or create a new key without password: ssh-keygen -t ed25519 -N '' -f ~/.ssh/github_actions"
          else
            echo "✅ SERVER_SSH_PASSPHRASE is set"
          fi
          
          echo "✅ All required secrets are set"

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Build backend
        working-directory: ./backend
        run: |
          go mod download
          go build -o app ./cmd/app

      - name: Build frontend
        working-directory: ./frontend
        run: |
          npm ci --legacy-peer-deps
          npm run build
          # Проверка, что сборка прошла успешно
          if [ ! -d "dist" ]; then
            echo "❌ Error: frontend/dist directory not found after build"
            exit 1
          fi
          echo "✅ Frontend build successful"
          ls -la dist/ | head -10

      - name: Verify frontend files
        run: |
          if [ ! -d "frontend/dist" ]; then
            echo "❌ Error: frontend/dist does not exist"
            exit 1
          fi
          if [ ! -f "frontend/nginx.conf" ]; then
            echo "❌ Error: frontend/nginx.conf does not exist"
            exit 1
          fi
          echo "✅ Frontend files verified"
          echo "dist size: $(du -sh frontend/dist | cut -f1)"
          echo "nginx.conf exists: $(test -f frontend/nginx.conf && echo 'yes' || echo 'no')"

      - name: Create production Dockerfile
        run: |
          cat > /tmp/Dockerfile.prod << 'EOF'
          FROM nginx:alpine
          COPY dist /usr/share/nginx/html
          COPY nginx.conf /etc/nginx/conf.d/default.conf
          EXPOSE 80
          HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
            CMD wget --quiet --tries=1 --spider http://localhost/health || exit 1
          CMD ["nginx", "-g", "daemon off;"]
          EOF
          echo "✅ Production Dockerfile created"

      - name: Deploy backend to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          passphrase: ${{ secrets.SERVER_SSH_PASSPHRASE }}
          port: ${{ secrets.SERVER_PORT || '22' }}
          source: "backend/app,backend/configs,backend/migrations,backend/docs,backend/Makefile"
          target: "/opt/synchronous/backend"
          strip_components: 1

      - name: Create frontend archive
        run: |
          echo "Checking frontend files..."
          ls -la frontend/ || echo "frontend directory not found"
          ls -la frontend/dist/ | head -10 || echo "dist not found"
          test -f frontend/nginx.conf && echo "nginx.conf exists" || echo "nginx.conf NOT found"
          
          echo "Creating archive..."
          cd frontend
          tar -czf /tmp/frontend-deploy.tar.gz dist nginx.conf
          cd ..
          
          echo "Verifying archive..."
          if [ ! -f /tmp/frontend-deploy.tar.gz ]; then
            echo "❌ Archive was not created!"
            exit 1
          fi
          
          ARCHIVE_SIZE=$(stat -f%z /tmp/frontend-deploy.tar.gz 2>/dev/null || stat -c%s /tmp/frontend-deploy.tar.gz 2>/dev/null || echo "0")
          if [ "$ARCHIVE_SIZE" -eq 0 ]; then
            echo "❌ Archive is empty!"
            exit 1
          fi
          
          echo "✅ Frontend archive created successfully (size: $ARCHIVE_SIZE bytes)"
          ls -lh /tmp/frontend-deploy.tar.gz
          tar -tzf /tmp/frontend-deploy.tar.gz | head -10

      - name: Deploy frontend archive
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          passphrase: ${{ secrets.SERVER_SSH_PASSPHRASE }}
          port: ${{ secrets.SERVER_PORT || '22' }}
          source: "/tmp/frontend-deploy.tar.gz"
          target: "/tmp"
          debug: true

      - name: Extract frontend on server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          passphrase: ${{ secrets.SERVER_SSH_PASSPHRASE }}
          port: ${{ secrets.SERVER_PORT || '22' }}
          script: |
            mkdir -p /opt/synchronous/frontend
            cd /opt/synchronous/frontend
            rm -rf dist nginx.conf Dockerfile || true
            tar -xzf /tmp/frontend-deploy.tar.gz
            rm /tmp/frontend-deploy.tar.gz
            echo "✅ Frontend files extracted"

      - name: Copy Dockerfile separately
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          passphrase: ${{ secrets.SERVER_SSH_PASSPHRASE }}
          port: ${{ secrets.SERVER_PORT || '22' }}
          source: "/tmp/Dockerfile.prod"
          target: "/opt/synchronous/frontend/Dockerfile"

      - name: Run migrations
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          passphrase: ${{ secrets.SERVER_SSH_PASSPHRASE }}
          port: ${{ secrets.SERVER_PORT || '22' }}
          script: |
            cd /opt/synchronous/backend
            export DB_DSN="${{ secrets.DB_DSN }}"
            make migrate-up || true

      - name: Restart services
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          passphrase: ${{ secrets.SERVER_SSH_PASSPHRASE }}
          port: ${{ secrets.SERVER_PORT || '22' }}
          script: |
            # Restart backend service
            sudo systemctl restart synchronous
            sudo systemctl status synchronous --no-pager
            
            # Restart frontend container (if using Docker)
            cd /opt/synchronous
            if [ -f docker-compose.yml ]; then
              echo "Rebuilding frontend container..."
              cd frontend
              docker build -t synchronous_frontend:latest .
              cd ..
              docker compose up -d frontend
            fi

      - name: Health check
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          passphrase: ${{ secrets.SERVER_SSH_PASSPHRASE }}
          port: ${{ secrets.SERVER_PORT || '22' }}
          script: |
            sleep 5
            echo "Checking backend health..."
            curl -f http://localhost:8080/api/v1/health || exit 1
            echo "Checking frontend health..."
            curl -f http://localhost:3000/health || curl -f http://localhost/health || echo "Frontend health check skipped"
