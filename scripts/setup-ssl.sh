#!/bin/bash

set -e

echo "ðŸ” ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° SSL ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð°..."

# Ð¦Ð²ÐµÑ‚Ð°
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ñ certbot
if ! command -v certbot &> /dev/null; then
    echo -e "${YELLOW}Certbot Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½. Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ°...${NC}"
    apt-get update
    apt-get install -y certbot python3-certbot-nginx
fi

# Ð—Ð°Ð¿Ñ€Ð¾Ñ Ð´Ð¾Ð¼ÐµÐ½Ð°
read -p "Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð²Ð°Ñˆ Ð´Ð¾Ð¼ÐµÐ½ (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€: api.example.com): " DOMAIN

if [ -z "$DOMAIN" ]; then
    echo -e "${RED}Ð”Ð¾Ð¼ÐµÐ½ Ð½Ðµ ÑƒÐºÐ°Ð·Ð°Ð½. Ð’Ñ‹Ñ…Ð¾Ð´.${NC}"
    exit 1
fi

echo -e "${GREEN}ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° SSL Ð´Ð»Ñ Ð´Ð¾Ð¼ÐµÐ½Ð°: $DOMAIN${NC}"

# ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸ Nginx Ð´Ð»Ñ Ð´Ð¾Ð¼ÐµÐ½Ð°
cat > /opt/synchronous/nginx/conf.d/synchronous.conf << EOF
server {
    listen 80;
    server_name $DOMAIN;

    # Ð’Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ð¹ Ñ€ÐµÐ´Ð¸Ñ€ÐµÐºÑ‚ Ð½Ð° HTTPS (Ð¿Ð¾ÑÐ»Ðµ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð°)
    # location / {
    #     return 301 https://\$server_name\$request_uri;
    # }

    # Ð”Ð»Ñ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð° - Ð¿Ñ€Ð¾ÐºÑÐ¸Ñ€ÑƒÐµÐ¼ Ð½Ð° backend
    location / {
        proxy_pass http://backend:8080;
        proxy_http_version 1.1;
        proxy_set_header Upgrade \$http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
        proxy_cache_bypass \$http_upgrade;
    }
}
EOF

# ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐº Nginx
docker compose -f /opt/synchronous/docker-compose.yml restart nginx

# ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð°
echo -e "${GREEN}ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ SSL ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð°...${NC}"
certbot --nginx -d $DOMAIN --non-interactive --agree-tos --email admin@$DOMAIN --redirect

echo -e "${GREEN}âœ… SSL Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½!${NC}"
echo ""
echo "Ð¢ÐµÐ¿ÐµÑ€ÑŒ Ð²Ð°Ñˆ ÑÐ°Ð¹Ñ‚ Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ Ð¿Ð¾ https://$DOMAIN"

