.PHONY: run migrate-up migrate-down migrate-status migrate-create migrate-reset migrate-fix migrate-version install-goose check-goose migrate-up-docker migrate-status-docker migrate-down-docker migrate-script-docker migrate-up-docker-explicit help

# –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
run:
	go run cmd/app/main.go

# ============================================================================
# –ú–∏–≥—Ä–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö —Å goose
# ============================================================================
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
#   DB_DSN="postgres://user:password@localhost:5432/database?sslmode=disable" make migrate-up
#   –∏–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è: export DB_DSN="..."
# ============================================================================

# DSN –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–º–æ–∂–Ω–æ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è)
DB_DSN ?= postgres://user:password@localhost:5432/database?sslmode=disable

# –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —Å –º–∏–≥—Ä–∞—Ü–∏—è–º–∏
MIGRATIONS_DIR = migrations

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è goose
check-goose:
	@which goose > /dev/null || (echo "‚ùå goose –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –ó–∞–ø—É—Å—Ç–∏—Ç–µ: make install-goose" && exit 1)

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ goose
install-goose:
	@echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ goose..."
	@go install github.com/pressly/goose/v3/cmd/goose@latest
	@echo "‚úÖ goose —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"

# –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –≤—Å–µ—Ö –º–∏–≥—Ä–∞—Ü–∏–π
migrate-up: check-goose
	@echo "üöÄ –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π..."
	@goose -dir $(MIGRATIONS_DIR) postgres "$(DB_DSN)" up
	@echo "‚úÖ –ú–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã"

# –û—Ç–∫–∞—Ç –ø–æ—Å–ª–µ–¥–Ω–µ–π –º–∏–≥—Ä–∞—Ü–∏–∏
migrate-down: check-goose
	@echo "‚¨áÔ∏è  –û—Ç–∫–∞—Ç –ø–æ—Å–ª–µ–¥–Ω–µ–π –º–∏–≥—Ä–∞—Ü–∏–∏..."
	@goose -dir $(MIGRATIONS_DIR) postgres "$(DB_DSN)" down
	@echo "‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è –æ—Ç–∫–∞—á–µ–Ω–∞"

# –°—Ç–∞—Ç—É—Å –º–∏–≥—Ä–∞—Ü–∏–π
migrate-status: check-goose
	@echo "üìä –°—Ç–∞—Ç—É—Å –º–∏–≥—Ä–∞—Ü–∏–π:"
	@goose -dir $(MIGRATIONS_DIR) postgres "$(DB_DSN)" status

# –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏
migrate-create: check-goose
	@read -p "–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏: " name; \
	goose -dir $(MIGRATIONS_DIR) create $$name sql && \
	echo "‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞: $(MIGRATIONS_DIR)/$$name"

# –ü–æ–ª–Ω—ã–π –æ—Ç–∫–∞—Ç –≤—Å–µ—Ö –º–∏–≥—Ä–∞—Ü–∏–π (–û–ü–ê–°–ù–û!)
migrate-reset: check-goose
	@echo "‚ö†Ô∏è  –í–ù–ò–ú–ê–ù–ò–ï: –≠—Ç–æ —É–¥–∞–ª–∏—Ç –≤—Å–µ –¥–∞–Ω–Ω—ã–µ!"
	@read -p "–í—ã —É–≤–µ—Ä–µ–Ω—ã? (yes/no): " confirm; \
	if [ "$$confirm" != "yes" ]; then \
		echo "‚ùå –û—Ç–º–µ–Ω–µ–Ω–æ"; \
		exit 1; \
	fi; \
	goose -dir $(MIGRATIONS_DIR) postgres "$(DB_DSN)" reset && \
	echo "‚úÖ –í—Å–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –æ—Ç–∫–∞—á–µ–Ω—ã"

# –§–∏–∫—Å–∞—Ü–∏—è –≤–µ—Ä—Å–∏–∏ –º–∏–≥—Ä–∞—Ü–∏–∏ (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö)
migrate-fix: check-goose
	@echo "üîß –§–∏–∫—Å–∞—Ü–∏—è –≤–µ—Ä—Å–∏–∏ –º–∏–≥—Ä–∞—Ü–∏–∏..."
	@goose -dir $(MIGRATIONS_DIR) postgres "$(DB_DSN)" fix

# –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π –¥–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –≤–µ—Ä—Å–∏–∏
migrate-version: check-goose
	@if [ -z "$(VERSION)" ]; then \
		echo "‚ùå –£–∫–∞–∂–∏—Ç–µ –≤–µ—Ä—Å–∏—é: make migrate-version VERSION=123"; \
		exit 1; \
	fi
	@echo "üéØ –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π –¥–æ –≤–µ—Ä—Å–∏–∏ $(VERSION)..."
	@goose -dir $(MIGRATIONS_DIR) postgres "$(DB_DSN)" up-to $(VERSION)
	@echo "‚úÖ –ú–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã –¥–æ –≤–µ—Ä—Å–∏–∏ $(VERSION)"

# ============================================================================
# –ú–∏–≥—Ä–∞—Ü–∏–∏ –≤ Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
# ============================================================================

# –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç DB_DSN –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞)
migrate-up-docker:
	@echo "üê≥ –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π –≤ Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ..."
	@cd .. && docker compose run --rm backend sh -c 'goose -dir migrations postgres "$$DB_DSN" up'
	@echo "‚úÖ –ú–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã"

# –°—Ç–∞—Ç—É—Å –º–∏–≥—Ä–∞—Ü–∏–π –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
migrate-status-docker:
	@echo "üê≥ –°—Ç–∞—Ç—É—Å –º–∏–≥—Ä–∞—Ü–∏–π –≤ Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ:"
	@cd .. && docker compose run --rm backend sh -c 'goose -dir migrations postgres "$$DB_DSN" status'

# –û—Ç–∫–∞—Ç –ø–æ—Å–ª–µ–¥–Ω–µ–π –º–∏–≥—Ä–∞—Ü–∏–∏ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
migrate-down-docker:
	@echo "üê≥ –û—Ç–∫–∞—Ç –ø–æ—Å–ª–µ–¥–Ω–µ–π –º–∏–≥—Ä–∞—Ü–∏–∏ –≤ Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ..."
	@cd .. && docker compose run --rm backend sh -c 'goose -dir migrations postgres "$$DB_DSN" down'
	@echo "‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è –æ—Ç–∫–∞—á–µ–Ω–∞"

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–∞ migrate.sh –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
migrate-script-docker:
	@echo "üê≥ –ó–∞–ø—É—Å–∫ –º–∏–≥—Ä–∞—Ü–∏–π —á–µ—Ä–µ–∑ —Å–∫—Ä–∏–ø—Ç –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ..."
	@cd .. && (docker compose exec backend sh /root/scripts/migrate.sh 2>/dev/null || \
		docker compose run --rm backend sh /root/scripts/migrate.sh)

# –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π —Å —è–≤–Ω–æ–π –ø–µ—Ä–µ–¥–∞—á–µ–π DSN (–µ—Å–ª–∏ DB_DSN –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ)
migrate-up-docker-explicit:
	@echo "üê≥ –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π –≤ Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ (—Å —è–≤–Ω—ã–º DSN)..."
	@if [ -z "$(DB_DSN)" ]; then \
		echo "‚ùå –£–∫–∞–∂–∏—Ç–µ DB_DSN: make migrate-up-docker-explicit DB_DSN=\"postgres://...\""; \
		exit 1; \
	fi
	@cd .. && docker compose run --rm -e DB_DSN="$(DB_DSN)" backend sh -c 'goose -dir migrations postgres "$$DB_DSN" up'
	@echo "‚úÖ –ú–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã"

# –°–ø—Ä–∞–≤–∫–∞
help:
	@echo "üìö –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–π:"
	@echo ""
	@echo "–õ–æ–∫–∞–ª—å–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã (—Ç—Ä–µ–±—É—é—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–π goose):"
	@echo "  make install-goose          - –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å goose"
	@echo "  make migrate-up              - –ü—Ä–∏–º–µ–Ω–∏—Ç—å –≤—Å–µ –º–∏–≥—Ä–∞—Ü–∏–∏"
	@echo "  make migrate-down            - –û—Ç–∫–∞—Ç–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω—é—é –º–∏–≥—Ä–∞—Ü–∏—é"
	@echo "  make migrate-status          - –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç—É—Å –º–∏–≥—Ä–∞—Ü–∏–π"
	@echo "  make migrate-create          - –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –º–∏–≥—Ä–∞—Ü–∏—é"
	@echo "  make migrate-reset           - –û—Ç–∫–∞—Ç–∏—Ç—å –≤—Å–µ –º–∏–≥—Ä–∞—Ü–∏–∏ (–û–ü–ê–°–ù–û!)"
	@echo "  make migrate-fix             - –ò—Å–ø—Ä–∞–≤–∏—Ç—å –≤–µ—Ä—Å–∏—é –º–∏–≥—Ä–∞—Ü–∏–∏"
	@echo "  make migrate-version VERSION=123 - –ü—Ä–∏–º–µ–Ω–∏—Ç—å –¥–æ –≤–µ—Ä—Å–∏–∏"
	@echo ""
	@echo "Docker –∫–æ–º–∞–Ω–¥—ã (—Ä–∞–±–æ—Ç–∞—é—Ç –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ):"
	@echo "  make migrate-up-docker        - –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç DB_DSN –∏–∑ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞)"
	@echo "  make migrate-status-docker    - –°—Ç–∞—Ç—É—Å –º–∏–≥—Ä–∞—Ü–∏–π –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ"
	@echo "  make migrate-down-docker      - –û—Ç–∫–∞—Ç–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ"
	@echo "  make migrate-script-docker    - –ó–∞–ø—É—Å—Ç–∏—Ç—å —á–µ—Ä–µ–∑ migrate.sh"
	@echo "  make migrate-up-docker-explicit DB_DSN=\"...\" - –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Å —è–≤–Ω—ã–º DSN"
	@echo ""
	@echo "–ü—Ä–∏–º–µ—Ä—ã:"
	@echo "  DB_DSN=\"postgres://user:pass@localhost:5432/db?sslmode=disable\" make migrate-up"
	@echo "  make migrate-up-docker"
	@echo "  make migrate-version VERSION=5"
	@echo ""